#!/bin/bash

# Git hook to validate commit message format
# This hook is triggered when writing a commit message

# Load common utilities
# When installed in .git/hooks/, this goes up to project root, then to .githooks/
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
source "$SCRIPT_DIR/.githooks/common.sh"

commit_msg_file=$1
commit_msg=$(cat "$commit_msg_file")

# Ignore merge commits
if echo "$commit_msg" | grep -qE "^Merge"; then
    exit 0
fi

# Minimum length check
if [ ${#commit_msg} -lt $MIN_COMMIT_MSG_LENGTH ]; then
    error "Commit message too short"
    echo -e "  Minimum length: ${MIN_COMMIT_MSG_LENGTH} characters"
    echo -e "  Your message: ${#commit_msg} characters"
    echo ""
    section "Tip:"
    echo "  Write descriptive commit messages that explain what and why"
    exit 1
fi

# Check for common bad patterns
if echo "$commit_msg" | grep -qiE "$GENERIC_COMMIT_PATTERNS"; then
    warning "Generic commit message detected"
    echo -e "  Message: ${commit_msg}"
    echo ""
    section "Consider a more descriptive message like:"
    echo -e "  ${GREEN}✓${NC} Add momentum-based trading strategy"
    echo -e "  ${GREEN}✓${NC} Fix calculation error in profit/loss computation"
    echo -e "  ${GREEN}✓${NC} Refactor data pipeline for better performance"
    echo ""
    if ! ask_yes_no "Continue anyway?"; then
        exit 1
    fi
fi

# Optional: Conventional Commits format check (uncomment to enable)
# if ! echo "$commit_msg" | grep -qE "^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .+"; then
#     warning "Consider using Conventional Commits format:"
#     echo -e "  feat: Add new feature"
#     echo -e "  fix: Fix bug"
#     echo -e "  docs: Update documentation"
#     echo -e "  refactor: Refactor code"
#     echo ""
# fi

success "Commit message looks good"
exit 0

